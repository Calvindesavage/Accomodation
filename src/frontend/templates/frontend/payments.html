{% extends 'frontend/base.html' %}

{% block title %}Payments - Hotel Booking System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="bi bi-credit-card"></i> Payment Management</h1>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                <i class="bi bi-plus-circle"></i> Record Payment
            </button>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="paymentsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Payment ID</th>
                            <th>Booking ID</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPaymentForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="booking" class="form-label">Booking</label>
                        <select class="form-control" id="booking" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-control" id="paymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="cash">Cash</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="debit_card">Debit Card</option>
                            <option value="bkash">bKash</option>
                            <option value="nagad">Nagad</option>
                            <option value="rocket">Rocket</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem('token');

// Load payments
async function loadPayments() {
    try {
        const response = await fetch('/api/payment/', {
            headers: { 'Authorization': `Token ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(payment => {
                    tbody.innerHTML += `
                        <tr>
                            <td>#${payment.id}</td>
                            <td>#${payment.booking}</td>
                            <td>$${payment.amount}</td>
                            <td><span class="badge bg-secondary">${payment.payment_method}</span></td>
                            <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deletePayment(${payment.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No payments found</td></tr>';
            }
        }
    } catch (error) {
        console.error('Error loading payments:', error);
    }
}

// Load bookings for dropdown
async function loadBookingsDropdown() {
    try {
        const response = await fetch('/api/booking/', {
            headers: { 'Authorization': `Token ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            const select = document.getElementById('booking');
            select.innerHTML = '<option value="">Select Booking</option>';
            
            if (data.results) {
                data.results.forEach(booking => {
                    select.innerHTML += `<option value="${booking.id}">Booking #${booking.id} - ${booking.customer_phone_no}</option>`;
                });
            }
        }
    } catch (error) {
        console.error('Error loading bookings:', error);
    }
}

// Add payment
document.getElementById('addPaymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const paymentData = {
        booking: parseInt(document.getElementById('booking').value),
        amount: parseFloat(document.getElementById('amount').value),
        payment_method: document.getElementById('paymentMethod').value
    };
    
    try {
        const response = await fetch('/api/payment/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentData)
        });
        
        if (response.ok) {
            alert('Payment recorded successfully!');
            document.getElementById('addPaymentForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('addPaymentModal')).hide();
            loadPayments();
        } else {
            alert('Failed to record payment');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error recording payment');
    }
});

function deletePayment(id) {
    if (confirm('Are you sure you want to delete this payment?')) {
        fetch(`/api/payment/${id}/`, {
            method: 'DELETE',
            headers: { 'Authorization': `Token ${token}` }
        }).then(response => {
            if (response.ok) {
                alert('Payment deleted successfully!');
                loadPayments();
            }
        });
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    loadPayments();
    loadBookingsDropdown();
});
</script>
{% endblock %}

